# Maintainer: aliena <dairyman@njsm.de>
pkgname=stocks-server
pkgver=0.1
pkgrel=2
pkgdesc="Stocks server framework"
arch=('i686' 'x86_64')
url="https://github.com/F1rst-Unicorn/stocks"
license=('MIT')
depends=('jre8-openjdk'
         'java-environment'
         'nginx'
         'openssl'
         'mariadb')
makedepends=('git'
			 'wget'
			 'maven')
source=("git://www.github.com/F1rst-Unicorn/stocks")
install=stocks-server.install
sha512sums=('SKIP')
backup=('etc/stocks/stocks.properties'
		'usr/lib/systemd/system/stocks-ocsp.service'
		'usr/lib/stocks/server'
		'usr/lib/stocks/setup-ca')

build() {
    cd "$srcdir/stocks"

    cd server
    mvn compile package
    cd ..
    mkdir -p root/jetty-base/wars
    cp server/target/server-$pkgver.war root/jetty-base/wars/server.war

    cd sentry
    mvn compile package
    cd ..
    cp sentry/target/sentry-$pkgver.war root/jetty-base/wars/sentry.war
                        
    wget -4 -O jetty.tar.gz "http://eclipse.org/downloads/download.php?file=/jetty/stable-9/dist/jetty-distribution-9.3.8.v20160314.tar.gz&r=1"
}

package() {
    cd "$srcdir/stocks"
    
    mkdir -p $pkgdir/usr/share/stocks
    cp -r root $pkgdir/usr/share/stocks
    cp database/schema.sql $pkgdir/usr/share/stocks/schema.sql
    cp deploy/nginx.conf $pkgdir/usr/share/stocks/nginx.example.conf
    
    mkdir -p $pkgdir/usr/share/stocks/root/CA/intermediate
    cp deploy/openssl.cnf $pkgdir/usr/share/stocks/root/CA/
    cp deploy/openssl_intermediate.cnf $pkgdir/usr/share/stocks/root/CA/intermediate/openssl.cnf
    
    mkdir -p $pkgdir/usr/lib/stocks/
    cp deploy/setup-ca $pkgdir/usr/lib/stocks/
    cp deploy/server $pkgdir/usr/lib/stocks
    chmod -R 755 $pkgdir/usr/lib/stocks/
    
    mkdir -p $pkgdir/etc/stocks/
    cp deploy/stocks.properties $pkgdir/etc/stocks
    
    mkdir -p $pkgdir/usr/share/doc/stocks/
    cp README.md $pkgdir/usr/share/doc/stocks/
    chmod -R 755 $pkgdir/usr/share/doc/stocks/
    
    tar xzf jetty.tar.gz
    mkdir -p $pkgdir/opt/stocks-jetty
    mv jetty-distribution-9.3.8.v20160314/* $pkgdir/opt/stocks-jetty
    chown -R root:root $pkgdir/opt/stocks-jetty
    rm -rf $pkgdir/opt/stocks-jetty/demo-base
    
    mkdir -p $pkgdir/usr/lib/systemd/system/
    cp deploy/stocks-jetty.service $pkgdir/usr/lib/systemd/system/
    cp deploy/stocks-ocsp.service $pkgdir/usr/lib/systemd/system/

    mkdir -p $pkgdir/usr/share/licenses/$pkgname/
    cp LICENSE.md $pkgdir/usr/share/licenses/$pkgname/
}
